# セキュリティレビュー（2024-09-21）

## 重点確認ポイント
- NextAuth.js による Google OAuth の設定とセッション扱い
- MongoDB への書き込み経路（ユーザー upsert / 投稿 CRUD / リアクション）
- API レイヤーの認可・エラーハンドリング
- フロントエンドでの秘匿情報露出有無

## 評価サマリ
- ✅ すべての API で `getServerSession` を強制し、未認証時は 401 を返す
- ✅ 投稿操作はサーバーアクション／API の両面で `authorId === session.user.id` を検証
- ✅ 入力値は Zod スキーマでサーバーサイド検証され、文字列トリミングも実施
- ✅ `.env.example` で主要シークレットを明示、`NEXTAUTH_SECRET` などが必須化
- ⚠️ Google プロフィールからメールアドレスが得られない場合があるため、`signIn` コールバックで明示的に `email` の存在チェックを追加（実装済み）
- ⚠️ API レスポンスの一般例外ではメッセージ文字列がそのまま返るため、運用時はロガー側で詳細メッセージと公開メッセージを分離することを推奨

## 推奨フォローアップ
1. **セッション有効期間の明示管理**: `NEXTAUTH_SESSION_TOKEN_MAX_AGE` を環境変数で設定し、短期化や再認証ポリシーを決定
2. **監査ログ**: 投稿/編集/削除操作と認証イベントを BigQuery や専用 log store に出力
3. **依存パッケージの監査**: CI 上で `pnpm audit` を定期実行し、Critical 以上は即時対応
4. **Rate Limiting**: 投稿 API に対して `@upstash/ratelimit` 等の導入を検討（ブルートフォース防止）

## 結論
現状の実装は会員制掲示板として必要な最低限の防御ラインを満たしている。上記推奨事項をバックログに登録し、βリリース前に優先順位付けして対応すること。
