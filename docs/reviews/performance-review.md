# パフォーマンスレビュー（2024-09-21）

## 分析対象
- MongoDB スキーマとインデックス設計
- 投稿一覧 (`listPosts`) の集約ロジック
- クライアントの無限スクロール実装
- Next.js Rendering モード（App Router / SSR）

## ポジティブ
- 投稿コレクションに `{ categoryId: 1, createdAt: -1 }` を設定し、カテゴリフィードのクエリ最適化済み
- リアクション数の集約は `$match` → `$group` の短いパイプラインで局所化
- クライアントは IntersectionObserver を用いた段階ロードで初期レンダリング量を最小化
- カテゴリ一覧は sign-in イベントでシード＆キャッシュのみ取得（N+1 を抑制）

## 改善余地
1. **リアクション集計の二重クエリ**: `summarizeReactions` で `aggregate` と `find` の2本を走らせている。将来的には `$group` 結果を `viewer` 用 `$match` に拡張し 1 クエリに統合可能。
2. **一覧再検証**: `listPosts` は常にライブクエリ。読み取り負荷が上がった際、`next: { revalidate: 60 }` や Redis キャッシュを併用する余地あり。
3. **画像最適化**: いまは Google アバター URL をそのまま利用。`next/image` + `loader` で遅延読み込み & 最適化を検討。
4. **クライアントバンドル**: MUI, next-intl, react-hook-form などで初期バンドルが~300KB 程度見込み。`analyze` プラグインを導入し、Tree Shaking の効果測定を推奨。

## 結論
現状スケール（初期ローンチ）ではボトルネック要素は見当たらない。利用状況に応じて上記改善をスプリントに組み込み、特にリアクション集計とキャッシュ戦略の最適化を優先したい。
