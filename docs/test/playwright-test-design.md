# Playwright E2E Test Design Document

## 1. 概要

本ドキュメントは、anotokiアプリケーションのPlaywright E2Eテストの詳細設計書です。
すべての画面遷移、ユーザーフロー、画面間の相互作用について、正常系・異常系・境界値のテストケースを網羅的に定義します。

## 2. テスト環境と前提条件

### 2.1 テスト環境
- **ブラウザ**: Chromium（Playwrightデフォルト）
- **テスト実行環境**: ローカル開発環境（http://localhost:3100）
- **データベース**: テスト用MongoDBインスタンス
- **認証**: Google OAuthのモック実装

### 2.2 前提条件
- テストデータの事前投入（シードデータ）
- テスト用ユーザーアカウントの準備
- 各テスト実行前のデータベースリセット
- テスト実行後のクリーンアップ

### 2.3 テスト対象画面
1. ログイン画面（/login）
2. ダッシュボード画面（/dashboard）
3. 投稿作成画面（/posts/new）
4. 投稿編集画面（/posts/[id]/edit）
5. 投稿詳細画面（/posts/[id]）
6. カテゴリ別投稿一覧画面（/categories/[slug]）

## 3. 認証フロー テストケース

### 3.1 ログイン画面（/login）

#### 3.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | Google OAuth認証成功 | 1. /loginアクセス<br>2. Googleボタンクリック<br>3. 認証完了 | ダッシュボードにリダイレクト | URL、セッション、ヘッダー表示 |
| 2 | 初回ログイン | 1. 新規Googleアカウント<br>2. 認証完了 | ユーザー作成後ダッシュボード | DBにユーザー作成確認 |
| 3 | 2回目以降ログイン | 1. 既存アカウント<br>2. 認証完了 | 既存ユーザーでダッシュボード | 最終ログイン時刻更新 |
| 4 | リダイレクト付きログイン | 1. 保護ページアクセス<br>2. ログイン画面<br>3. 認証 | 元のページにリダイレクト | returnUrl処理確認 |
| 5 | ログイン済みでアクセス | 1. 既にログイン済み<br>2. /loginアクセス | ダッシュボードにリダイレクト | 自動リダイレクト |
| 6 | ロケール維持 | 1. ja ロケール<br>2. ログイン | 日本語表示維持 | ロケール設定保持 |
| 7 | セッション有効期限延長 | 1. ログイン<br>2. 操作継続 | セッション維持 | Cookie有効期限確認 |
| 8 | ログアウト後再ログイン | 1. ログアウト<br>2. 再度ログイン | 正常にログイン | セッション再作成 |
| 9 | 複数タブでログイン | 1. タブ1でログイン<br>2. タブ2で確認 | 両タブでログイン状態 | セッション共有確認 |
| 10 | モバイルビューでログイン | 1. viewport変更<br>2. ログイン操作 | レスポンシブ表示 | UI崩れなし |
| 11 | プロフィール画像表示 | 1. ログイン完了<br>2. ヘッダー確認 | Googleプロフィール画像表示 | 画像URL有効性 |
| 12 | ユーザー名表示 | 1. ログイン完了<br>2. ヘッダー確認 | Google表示名表示 | 文字化けなし |
| 13 | ログインボタン無効化 | 1. ボタンクリック<br>2. 処理中 | ボタン無効化、ローディング | 二重送信防止 |
| 14 | ネットワーク遅延時 | 1. 低速ネットワーク<br>2. ログイン | ローディング表示 | タイムアウト処理 |
| 15 | ログイン成功通知 | 1. ログイン完了 | トースト通知表示 | 成功メッセージ |

#### 3.1.2 異常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | Google認証キャンセル | 1. Googleボタンクリック<br>2. 認証画面でキャンセル | ログイン画面に戻る | エラー表示なし |
| 2 | Google認証エラー | 1. 無効なアカウント<br>2. 認証試行 | エラーメッセージ表示 | エラートースト |
| 3 | ネットワークエラー | 1. ネットワーク切断<br>2. ログイン試行 | エラーメッセージ表示 | オフライン通知 |
| 4 | セッション作成失敗 | 1. DB接続エラー<br>2. ログイン試行 | エラー画面表示 | 500エラーページ |
| 5 | CSRF token不一致 | 1. 改ざんtoken<br>2. ログイン試行 | セキュリティエラー | 403エラー |
| 6 | Cookie無効環境 | 1. Cookie無効<br>2. ログイン試行 | Cookie有効化案内 | 警告メッセージ |
| 7 | JavaScript無効環境 | 1. JS無効<br>2. ページアクセス | 代替コンテンツ表示 | noscriptタグ |
| 8 | 権限不足アカウント | 1. 制限アカウント<br>2. ログイン | アクセス拒否 | 権限エラー |
| 9 | 削除済みアカウント | 1. 削除済みユーザー<br>2. ログイン試行 | アカウント無効通知 | 再登録案内 |
| 10 | 一時停止アカウント | 1. 停止中ユーザー<br>2. ログイン試行 | 停止通知表示 | 理由表示 |
| 11 | レート制限超過 | 1. 連続ログイン試行<br>2. 制限超過 | レート制限エラー | 429エラー |
| 12 | 無効なリダイレクトURL | 1. 改ざんreturnUrl<br>2. ログイン | デフォルトページへ | XSS防御 |
| 13 | タイムアウト | 1. 30秒待機<br>2. タイムアウト | タイムアウトエラー | リトライボタン |
| 14 | メンテナンス中 | 1. メンテナンスモード<br>2. ログイン試行 | メンテナンス画面 | 503エラー |
| 15 | 不正なOAuthレスポンス | 1. 改ざんレスポンス<br>2. コールバック | エラー画面 | セキュリティエラー |

### 3.2 ログアウトフロー

#### 3.2.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | ヘッダーからログアウト | 1. ユーザーメニュー<br>2. ログアウトクリック | ログイン画面へ | セッション削除 |
| 2 | ログアウト確認ダイアログ | 1. ログアウトクリック<br>2. 確認で「はい」 | ログアウト実行 | 確認UI表示 |
| 3 | ログアウトキャンセル | 1. ログアウトクリック<br>2. 確認で「いいえ」 | ログアウトキャンセル | 現在ページ維持 |
| 4 | 複数タブでログアウト | 1. タブ1でログアウト<br>2. タブ2確認 | 全タブでログアウト | セッション同期 |
| 5 | ログアウト後のアクセス制限 | 1. ログアウト<br>2. 保護ページアクセス | ログイン画面へ | 401リダイレクト |

## 4. ダッシュボード画面 テストケース

### 4.1 投稿一覧表示

#### 4.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 初期表示 | 1. ダッシュボードアクセス | 最新10件表示 | 投稿カード、日時順 |
| 2 | 無限スクロール | 1. 最下部までスクロール<br>2. 追加読み込み | 次の10件表示 | ローディング表示 |
| 3 | 最終ページ到達 | 1. 全件スクロール<br>2. 最後まで | 「これ以上ありません」表示 | 終了メッセージ |
| 4 | 投稿0件 | 1. 投稿なし状態<br>2. アクセス | 空状態表示 | 「投稿を作成」CTA |
| 5 | 投稿カード表示 | 1. 投稿確認 | タイトル、レッスン、タグ表示 | 全要素表示確認 |
| 6 | いいねボタン | 1. ハートクリック | いいね追加/削除トグル | カウント更新 |
| 7 | ブックマークボタン | 1. ブックマーククリック | ブックマーク追加/削除 | アイコン変化 |
| 8 | カテゴリバッジ | 1. カテゴリ表示確認 | カテゴリ名表示 | 色分け確認 |
| 9 | タグチップ | 1. タグ表示確認 | タグ一覧表示 | 最大5個表示 |
| 10 | 投稿者情報 | 1. 作者名表示確認 | 名前とアバター表示 | プロフィール画像 |
| 11 | 作成日時表示 | 1. 日時確認 | 相対時間表示 | 「○分前」形式 |
| 12 | Private投稿表示 | 1. 自分のprivate投稿 | 鍵アイコン付き表示 | visibility表示 |
| 13 | リアクション楽観的更新 | 1. いいねクリック | 即座にUI更新 | アニメーション |
| 14 | エラー時ロールバック | 1. いいね失敗 | 元の状態に戻る | エラートースト |
| 15 | Pull to Refresh | 1. 下にプル<br>2. リフレッシュ | 最新データ取得 | ローディング |

#### 4.1.2 フィルタリング・検索

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | キーワード検索 | 1. 検索欄入力<br>2. Enter | 検索結果表示 | タイトル/レッスンマッチ |
| 2 | 検索結果0件 | 1. マッチしない検索 | 「見つかりません」表示 | 空状態UI |
| 3 | 検索クリア | 1. ×ボタンクリック | 全件表示に戻る | フィルタ解除 |
| 4 | 日本語検索 | 1. 日本語入力<br>2. 検索 | 日本語マッチング | 全角/半角対応 |
| 5 | 特殊文字エスケープ | 1. 特殊文字入力<br>2. 検索 | 正常動作 | XSS防御 |
| 6 | カテゴリフィルタ | 1. カテゴリ選択<br>2. 適用 | カテゴリ別表示 | フィルタバッジ |
| 7 | タグフィルタ | 1. タグクリック<br>2. フィルタ | タグ別表示 | URLパラメータ |
| 8 | 複合フィルタ | 1. 検索+カテゴリ<br>2. 適用 | AND条件適用 | 絞り込み結果 |
| 9 | フィルタ永続化 | 1. フィルタ適用<br>2. リロード | フィルタ維持 | URLクエリ保持 |
| 10 | フィルタリセット | 1. リセットボタン | 全フィルタ解除 | 初期状態復帰 |

#### 4.1.3 投稿アクション

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 投稿詳細へ遷移 | 1. カードクリック | 詳細ページへ | スムーズ遷移 |
| 2 | 新規投稿ボタン | 1. +ボタンクリック | 作成ページへ | FABボタン動作 |
| 3 | 編集ボタン（自分の投稿） | 1. 編集アイコンクリック | 編集ページへ | 権限確認 |
| 4 | 削除ボタン（自分の投稿） | 1. 削除アイコンクリック<br>2. 確認 | 投稿削除 | 確認ダイアログ |
| 5 | 他人の投稿（編集不可） | 1. 他人の投稿確認 | 編集/削除ボタンなし | 権限制御 |

### 4.2 サイドバー・ナビゲーション

#### 4.2.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | カテゴリ一覧表示 | 1. サイドバー確認 | 全カテゴリ表示 | アイコン付き |
| 2 | カテゴリ選択 | 1. カテゴリクリック | カテゴリページへ | URL遷移 |
| 3 | 現在カテゴリハイライト | 1. カテゴリページで確認 | アクティブ表示 | 背景色変化 |
| 4 | ダッシュボードリンク | 1. ホームクリック | ダッシュボードへ | ルート遷移 |
| 5 | モバイルメニュー | 1. ハンバーガークリック<br>2. メニュー表示 | ドロワー表示 | スライドイン |
| 6 | メニュー外クリック | 1. ドロワー表示<br>2. 外側クリック | ドロワー閉じる | オーバーレイ |
| 7 | サイドバー固定/解除 | 1. ピンアイコンクリック | 固定トグル | localStorage保存 |
| 8 | カテゴリ投稿数表示 | 1. カテゴリ横の数字 | 投稿数表示 | リアルタイム更新 |
| 9 | サイドバースクロール | 1. 多数カテゴリ<br>2. スクロール | スクロール可能 | スクロールバー |
| 10 | キーボードナビゲーション | 1. Tab/矢印キー | フォーカス移動 | アクセシビリティ |

## 5. 投稿作成画面 テストケース

### 5.1 フォーム入力

#### 5.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | タイトル入力 | 1. タイトル欄入力<br>2. 100文字まで | 正常入力 | 文字数カウンター |
| 2 | レッスン入力 | 1. レッスン欄入力<br>2. Markdown記法 | プレビュー表示 | リアルタイムプレビュー |
| 3 | カテゴリ選択 | 1. セレクトボックス<br>2. カテゴリ選択 | 選択反映 | 必須マーク |
| 4 | 状況説明入力 | 1. 状況欄入力<br>2. 500文字まで | 正常入力 | 任意項目 |
| 5 | タグ追加（1個） | 1. タグ入力<br>2. Enter | チップ追加 | タグ表示 |
| 6 | タグ追加（5個） | 1. 5個まで追加 | 最大5個表示 | 制限表示 |
| 7 | タグ削除 | 1. ×クリック | タグ削除 | チップ消去 |
| 8 | visibility選択 | 1. ラジオボタン<br>2. member/private | 選択切り替え | デフォルトmember |
| 9 | フォーム送信 | 1. 必須入力<br>2. 作成ボタン | 投稿作成成功 | 詳細ページへ |
| 10 | 下書き保存 | 1. 入力途中<br>2. 下書きボタン | localStorage保存 | 復元可能 |
| 11 | 自動保存 | 1. 入力中<br>2. 30秒経過 | 自動保存実行 | インジケーター |
| 12 | Markdownプレビュー | 1. レッスン入力<br>2. プレビュータブ | HTML表示 | 見出し、リスト |
| 13 | 画像アップロード | 1. 画像選択<br>2. アップロード | 画像挿入 | プレビュー表示 |
| 14 | キャンセル | 1. キャンセルボタン | ダッシュボードへ | 確認ダイアログ |
| 15 | 連続作成 | 1. 作成後<br>2. 「続けて作成」 | フォームリセット | 成功通知 |

#### 5.1.2 バリデーション

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | タイトル未入力 | 1. 空で送信 | エラー表示 | 必須エラー |
| 2 | タイトル最小（1文字） | 1. 1文字入力<br>2. 送信 | 正常送信 | 境界値 |
| 3 | タイトル最大（100文字） | 1. 100文字入力<br>2. 送信 | 正常送信 | 境界値 |
| 4 | タイトル超過（101文字） | 1. 101文字入力 | 入力制限 | 最大値制御 |
| 5 | レッスン未入力 | 1. 空で送信 | エラー表示 | 必須エラー |
| 6 | レッスン最小（1文字） | 1. 1文字入力<br>2. 送信 | 正常送信 | 境界値 |
| 7 | レッスン最大（5000文字） | 1. 5000文字入力<br>2. 送信 | 正常送信 | 境界値 |
| 8 | レッスン超過（5001文字） | 1. 5001文字入力 | エラー表示 | 最大値エラー |
| 9 | カテゴリ未選択 | 1. 未選択で送信 | エラー表示 | 必須エラー |
| 10 | タグ最大超過（6個） | 1. 6個目追加試行 | 追加不可 | 制限メッセージ |
| 11 | タグ文字数超過（21文字） | 1. 21文字入力 | エラー表示 | 文字数エラー |
| 12 | 空白のみ入力 | 1. スペースのみ<br>2. 送信 | エラー表示 | トリム処理 |
| 13 | 特殊文字入力 | 1. <script>等入力<br>2. 送信 | サニタイズ | XSS防御 |
| 14 | 絵文字入力 | 1. 絵文字入力<br>2. 送信 | 正常処理 | Unicode対応 |
| 15 | リアルタイムバリデーション | 1. 入力中 | エラー即座表示 | onBlurイベント |

#### 5.1.3 異常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | ネットワークエラー | 1. オフライン<br>2. 送信 | エラー通知 | リトライボタン |
| 2 | セッションタイムアウト | 1. 長時間放置<br>2. 送信 | 再ログイン促し | 401エラー |
| 3 | 同時編集競合 | 1. 別タブで同時作成<br>2. 送信 | 最後の送信優先 | 競合解決 |
| 4 | サーバーエラー | 1. 500エラー発生<br>2. 送信 | エラー通知 | エラー詳細 |
| 5 | カテゴリ削除済み | 1. 削除済みカテゴリ<br>2. 送信 | エラー通知 | 再選択促し |

## 6. 投稿編集画面 テストケース

### 6.1 編集フォーム

#### 6.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 既存データ読み込み | 1. 編集画面アクセス | 全フィールド表示 | データ取得 |
| 2 | タイトル編集 | 1. タイトル変更<br>2. 保存 | 更新成功 | 変更反映 |
| 3 | レッスン編集 | 1. レッスン変更<br>2. 保存 | 更新成功 | Markdown保持 |
| 4 | カテゴリ変更 | 1. 別カテゴリ選択<br>2. 保存 | カテゴリ更新 | 選択反映 |
| 5 | タグ編集 | 1. タグ追加/削除<br>2. 保存 | タグ更新 | チップ更新 |
| 6 | visibility変更 | 1. member→private<br>2. 保存 | 可視性変更 | 設定反映 |
| 7 | 部分更新 | 1. 一部のみ変更<br>2. 保存 | 変更箇所のみ更新 | 他フィールド維持 |
| 8 | 変更なし保存 | 1. 変更せず保存 | 正常完了 | 無駄な更新なし |
| 9 | プレビュー確認 | 1. 編集中<br>2. プレビュー | 変更反映 | リアルタイム |
| 10 | 編集キャンセル | 1. 編集中<br>2. キャンセル | 変更破棄 | 確認ダイアログ |
| 11 | 更新後リダイレクト | 1. 保存完了 | 詳細ページへ | 成功通知 |
| 12 | 更新日時表示 | 1. 保存後確認 | 更新日時更新 | タイムスタンプ |
| 13 | バージョン管理 | 1. 連続更新 | 最新版反映 | 競合なし |
| 14 | 自動保存復元 | 1. 途中離脱<br>2. 再アクセス | 下書き復元提案 | localStorage |
| 15 | 編集履歴 | 1. 履歴ボタン | 変更履歴表示 | 差分表示 |

#### 6.1.2 権限チェック

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 自分の投稿編集 | 1. 自分の投稿<br>2. 編集 | 正常編集可能 | 権限OK |
| 2 | 他人の投稿アクセス | 1. 他人の投稿URL<br>2. アクセス | 403エラー | アクセス拒否 |
| 3 | 削除済み投稿編集 | 1. 削除済みURL<br>2. アクセス | 404エラー | Not Found |
| 4 | 非ログインアクセス | 1. ログアウト状態<br>2. 編集URL | ログイン画面へ | 401リダイレクト |
| 5 | セッション切れ | 1. 編集中<br>2. セッション切れ | 再ログイン促し | 作業内容保存 |

## 7. 投稿詳細画面 テストケース

### 7.1 詳細表示

#### 7.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 投稿詳細表示 | 1. 詳細URLアクセス | 全内容表示 | 全フィールド |
| 2 | Markdownレンダリング | 1. レッスン確認 | HTML変換表示 | 書式適用 |
| 3 | タグ表示 | 1. タグ欄確認 | タグチップ表示 | クリッカブル |
| 4 | カテゴリ表示 | 1. カテゴリ確認 | カテゴリバッジ | リンク付き |
| 5 | 作成者情報 | 1. 作者欄確認 | プロフィール表示 | アバター画像 |
| 6 | 作成日時・更新日時 | 1. 日時確認 | 両方表示 | フォーマット済み |
| 7 | いいねボタン動作 | 1. いいねクリック | トグル動作 | カウント更新 |
| 8 | ブックマーク動作 | 1. ブックマーククリック | トグル動作 | アイコン変化 |
| 9 | 編集ボタン（本人） | 1. 自分の投稿 | 編集ボタン表示 | 編集ページへ |
| 10 | 削除ボタン（本人） | 1. 自分の投稿 | 削除ボタン表示 | 確認ダイアログ |
| 11 | シェアボタン | 1. シェアクリック | シェアメニュー | URL共有 |
| 12 | コピーリンク | 1. リンクコピー | クリップボード | コピー通知 |
| 13 | 関連投稿表示 | 1. 下部確認 | 同カテゴリ投稿 | 最大5件 |
| 14 | パンくずリスト | 1. 上部確認 | 階層表示 | ナビゲーション |
| 15 | メタ情報（OGP） | 1. ソース確認 | OGPタグ設定 | SNS共有対応 |

#### 7.1.2 アクセス制御

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | public投稿（誰でも） | 1. 未ログイン<br>2. アクセス | 正常表示 | ※現在はmemberのみ |
| 2 | member投稿（ログイン必須） | 1. ログイン済み<br>2. アクセス | 正常表示 | 認証確認 |
| 3 | member投稿（未ログイン） | 1. 未ログイン<br>2. アクセス | ログイン促し | 401リダイレクト |
| 4 | private投稿（本人のみ） | 1. 投稿者<br>2. アクセス | 正常表示 | 本人確認 |
| 5 | private投稿（他人） | 1. 他ユーザー<br>2. アクセス | 403エラー | アクセス拒否 |

#### 7.1.3 異常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 存在しない投稿 | 1. 無効なID<br>2. アクセス | 404エラー | Not Found |
| 2 | 削除済み投稿 | 1. 削除済みID<br>2. アクセス | 404エラー | 削除確認 |
| 3 | 不正なID形式 | 1. 不正ID<br>2. アクセス | 400エラー | バリデーション |
| 4 | データ取得エラー | 1. DBエラー時<br>2. アクセス | 500エラー | エラーページ |
| 5 | 長大なコンテンツ | 1. 巨大投稿<br>2. 表示 | 正常表示 | パフォーマンス |

## 8. カテゴリ別投稿一覧画面 テストケース

### 8.1 カテゴリフィルタリング

#### 8.1.1 正常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | カテゴリ別表示 | 1. /categories/work | work投稿のみ | フィルタ確認 |
| 2 | カテゴリ名表示 | 1. ヘッダー確認 | カテゴリ名表示 | 日本語名 |
| 3 | カテゴリ説明表示 | 1. 説明欄確認 | 説明文表示 | フォーマット |
| 4 | 投稿数表示 | 1. 件数確認 | 「○件の投稿」 | カウント正確 |
| 5 | 空カテゴリ | 1. 投稿0件カテゴリ | 空状態表示 | 作成CTA |
| 6 | ページネーション | 1. スクロール | 追加読み込み | 無限スクロール |
| 7 | サイドバーハイライト | 1. サイドバー確認 | 該当カテゴリ強調 | アクティブ状態 |
| 8 | パンくずリスト | 1. 上部確認 | Home > カテゴリ名 | 階層表示 |
| 9 | カテゴリ内検索 | 1. 検索入力 | カテゴリ内検索 | AND条件 |
| 10 | ソート順 | 1. 並び順確認 | 作成日降順 | 最新順 |

#### 8.1.2 異常系テストケース

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 存在しないカテゴリ | 1. /categories/invalid | 404エラー | Not Found |
| 2 | 削除済みカテゴリ | 1. 削除済みslug | 404エラー | 削除確認 |
| 3 | 特殊文字slug | 1. /categories/<script> | 400エラー | サニタイズ |
| 4 | 権限制限カテゴリ | 1. 制限付きカテゴリ | 403エラー | アクセス制御 |
| 5 | データ取得エラー | 1. DBエラー | 500エラー | エラーハンドリング |

## 9. 画面間の相互作用 テストケース

### 9.1 ユーザーフロー

#### 9.1.1 投稿作成フロー

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | 新規投稿完全フロー | 1. ログイン<br>2. ダッシュボード<br>3. 新規作成<br>4. 入力<br>5. 保存<br>6. 詳細表示 | 投稿作成完了 | E2Eフロー |
| 2 | 投稿編集フロー | 1. 自分の投稿<br>2. 編集<br>3. 変更<br>4. 保存<br>5. 確認 | 更新完了 | 変更反映 |
| 3 | 投稿削除フロー | 1. 自分の投稿<br>2. 削除<br>3. 確認<br>4. 一覧確認 | 削除完了 | リスト更新 |
| 4 | リアクションフロー | 1. 投稿表示<br>2. いいね<br>3. ブックマーク<br>4. 確認 | リアクション保存 | 永続化 |
| 5 | 検索→詳細フロー | 1. 検索実行<br>2. 結果表示<br>3. クリック<br>4. 詳細表示 | 正しい投稿表示 | 検索精度 |

#### 9.1.2 ナビゲーションフロー

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | カテゴリ巡回 | 1. カテゴリA<br>2. カテゴリB<br>3. ホーム | 正常遷移 | 状態保持 |
| 2 | ブラウザバック | 1. 詳細→一覧<br>2. バックボタン | 前ページへ | 履歴管理 |
| 3 | ディープリンク | 1. 直接URL入力<br>2. アクセス | 正常表示 | ルーティング |
| 4 | 404からの復帰 | 1. 404エラー<br>2. ホームへ戻る | ダッシュボード | エラー回復 |
| 5 | セッション維持 | 1. 長時間操作<br>2. 各画面遷移 | セッション継続 | 自動延長 |

### 9.2 エラーリカバリー

#### 9.2.1 エラー処理フロー

| No | テストケース | 操作手順 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | ネットワーク切断回復 | 1. オフライン<br>2. 操作<br>3. 復帰 | 自動リトライ | 復旧通知 |
| 2 | 認証エラー回復 | 1. セッション切れ<br>2. 再ログイン<br>3. 継続 | 作業復帰 | データ保持 |
| 3 | 保存エラーリトライ | 1. 保存失敗<br>2. リトライ<br>3. 成功 | 正常保存 | 冪等性 |
| 4 | 競合解決 | 1. 同時編集<br>2. 競合発生<br>3. 解決 | マージ/選択 | データ整合性 |
| 5 | 部分的障害 | 1. 一部機能停止<br>2. 他機能使用 | 縮退運転 | グレースフルデグレード |

## 10. パフォーマンス・UX テストケース

### 10.1 レスポンス速度

| No | テストケース | 測定項目 | 期待値 | 検証方法 |
|----|------------|----------|--------|----------|
| 1 | 初回ロード | FCP | <2秒 | Lighthouse |
| 2 | ページ遷移 | 遷移時間 | <1秒 | Performance API |
| 3 | 無限スクロール | 追加読み込み | <500ms | Network計測 |
| 4 | 検索レスポンス | 検索結果表示 | <1秒 | デバウンス確認 |
| 5 | いいね反映 | 楽観的更新 | 即座 | UI監視 |

### 10.2 レスポンシブデザイン

| No | テストケース | デバイス | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | モバイル表示 | 375×667 | 正常表示 | レイアウト崩れなし |
| 2 | タブレット表示 | 768×1024 | 正常表示 | 2カラム表示 |
| 3 | デスクトップ表示 | 1920×1080 | 正常表示 | 3カラム表示 |
| 4 | 画面回転 | 縦→横 | レイアウト調整 | 再配置 |
| 5 | ズーム対応 | 200%ズーム | 可読性維持 | オーバーフローなし |

### 10.3 アクセシビリティ

| No | テストケース | 検証項目 | 期待結果 | 確認方法 |
|----|------------|----------|----------|----------|
| 1 | キーボード操作 | Tab移動 | 全要素到達可能 | キーボードのみ |
| 2 | スクリーンリーダー | 読み上げ | 正確な読み上げ | NVDA/JAWS |
| 3 | カラーコントラスト | WCAG AA | 4.5:1以上 | axe DevTools |
| 4 | フォーカス表示 | フォーカスリング | 明確な表示 | 視覚確認 |
| 5 | エラー通知 | aria-live | 即座通知 | スクリーンリーダー |

## 11. セキュリティ テストケース

### 11.1 認証・認可

| No | テストケース | 攻撃手法 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | CSRF攻撃 | トークン改ざん | 拒否 | 403エラー |
| 2 | セッション固定 | セッションID固定 | 新規生成 | ID変更確認 |
| 3 | 権限昇格 | URL直接アクセス | アクセス拒否 | 403/404 |
| 4 | リプレイ攻撃 | リクエスト再送 | 拒否/冪等 | nonce確認 |
| 5 | ブルートフォース | 連続試行 | レート制限 | 429エラー |

### 11.2 入力検証

| No | テストケース | 攻撃手法 | 期待結果 | 検証項目 |
|----|------------|----------|----------|----------|
| 1 | XSS攻撃 | <script>注入 | サニタイズ | エスケープ確認 |
| 2 | SQLインジェクション | '; DROP TABLE | パラメータ化 | エラーなし |
| 3 | パストラバーサル | ../../etc/passwd | 拒否 | 400エラー |
| 4 | コマンドインジェクション | ; rm -rf | エスケープ | 実行防止 |
| 5 | XXE攻撃 | XML外部実体 | 無効化 | パース拒否 |

## 12. テスト実装例

### 12.1 ログインフローテスト

```typescript
import { test, expect } from '@playwright/test';

test.describe('ログインフロー', () => {
  test('Google OAuth認証成功', async ({ page }) => {
    // ログイン画面へアクセス
    await page.goto('/login');

    // Googleログインボタンが表示されることを確認
    const googleButton = page.getByRole('button', { name: /Googleでログイン/ });
    await expect(googleButton).toBeVisible();

    // OAuthモック設定
    await page.route('**/api/auth/signin/google', async route => {
      await route.fulfill({
        status: 302,
        headers: {
          'Location': '/dashboard'
        }
      });
    });

    // ボタンクリック
    await googleButton.click();

    // ダッシュボードへリダイレクトされることを確認
    await page.waitForURL('/dashboard');
    await expect(page).toHaveURL('/dashboard');

    // ユーザー情報が表示されることを確認
    await expect(page.getByTestId('user-avatar')).toBeVisible();
    await expect(page.getByTestId('user-name')).toContainText('テストユーザー');
  });

  test('未認証でのダッシュボードアクセス', async ({ page }) => {
    // 直接ダッシュボードへアクセス
    await page.goto('/dashboard');

    // ログイン画面へリダイレクト
    await page.waitForURL('/login');
    await expect(page).toHaveURL('/login');

    // リダイレクトメッセージ確認
    await expect(page.getByText('ログインが必要です')).toBeVisible();
  });
});
```

### 12.2 投稿作成テスト

```typescript
test.describe('投稿作成', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン状態をモック
    await page.addInitScript(() => {
      window.localStorage.setItem('session', JSON.stringify({
        user: { id: 'test-user', name: 'テストユーザー' }
      }));
    });
  });

  test('必須フィールドのバリデーション', async ({ page }) => {
    await page.goto('/posts/new');

    // 空のまま送信
    await page.getByRole('button', { name: '作成' }).click();

    // エラーメッセージ確認
    await expect(page.getByText('タイトルは必須です')).toBeVisible();
    await expect(page.getByText('レッスンは必須です')).toBeVisible();
    await expect(page.getByText('カテゴリを選択してください')).toBeVisible();
  });

  test('正常な投稿作成フロー', async ({ page }) => {
    await page.goto('/posts/new');

    // フォーム入力
    await page.getByLabel('タイトル').fill('テスト投稿');
    await page.getByLabel('レッスン').fill('これはテストレッスンです');
    await page.getByLabel('カテゴリ').selectOption('work');

    // タグ追加
    const tagInput = page.getByLabel('タグ');
    await tagInput.fill('テストタグ');
    await tagInput.press('Enter');

    // APIモック
    await page.route('**/api/posts', async route => {
      if (route.request().method() === 'POST') {
        await route.fulfill({
          status: 201,
          json: { id: 'new-post-id' }
        });
      }
    });

    // 送信
    await page.getByRole('button', { name: '作成' }).click();

    // 詳細ページへリダイレクト
    await page.waitForURL('/posts/new-post-id');
    await expect(page.getByRole('heading', { name: 'テスト投稿' })).toBeVisible();
  });
});
```

### 12.3 無限スクロールテスト

```typescript
test.describe('投稿一覧無限スクロール', () => {
  test('スクロールによる追加読み込み', async ({ page }) => {
    // 初期データモック
    await page.route('**/api/posts?page=1', async route => {
      await route.fulfill({
        json: {
          posts: Array(10).fill(null).map((_, i) => ({
            id: `post-${i}`,
            title: `投稿 ${i + 1}`,
            // ... その他フィールド
          })),
          hasMore: true,
          nextCursor: 'cursor-2'
        }
      });
    });

    // 2ページ目モック
    await page.route('**/api/posts?cursor=cursor-2', async route => {
      await route.fulfill({
        json: {
          posts: Array(5).fill(null).map((_, i) => ({
            id: `post-${i + 10}`,
            title: `投稿 ${i + 11}`,
          })),
          hasMore: false
        }
      });
    });

    await page.goto('/dashboard');

    // 初期10件表示確認
    await expect(page.getByTestId('post-card')).toHaveCount(10);

    // 最下部までスクロール
    await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));

    // ローディング表示
    await expect(page.getByTestId('loading-spinner')).toBeVisible();

    // 追加5件表示
    await expect(page.getByTestId('post-card')).toHaveCount(15);

    // 終了メッセージ
    await expect(page.getByText('すべて読み込みました')).toBeVisible();
  });
});
```

## 13. 実行計画

### 13.1 テスト優先度

#### Priority 1（必須）
- ログイン/ログアウト
- 投稿CRUD基本操作
- アクセス制御
- 必須フィールドバリデーション

#### Priority 2（重要）
- 検索・フィルタ機能
- リアクション機能
- ページネーション
- エラーハンドリング

#### Priority 3（推奨）
- パフォーマンステスト
- レスポンシブデザイン
- アクセシビリティ
- 細かいUX

### 13.2 テストデータ準備

```javascript
// テストユーザー
const testUsers = [
  { email: 'test1@example.com', name: 'テストユーザー1' },
  { email: 'test2@example.com', name: 'テストユーザー2' },
  { email: 'admin@example.com', name: '管理者' }
];

// テスト投稿
const testPosts = [
  { title: 'テスト投稿1', categoryId: 'work', visibility: 'member' },
  { title: 'テスト投稿2', categoryId: 'life', visibility: 'private' },
  // ... 100件のテストデータ
];

// テストカテゴリ
const testCategories = [
  { slug: 'work', name: '仕事' },
  { slug: 'life', name: '日常' },
  // ... 全カテゴリ
];
```

### 13.3 テスト環境リセット

```javascript
// 各テスト前
beforeEach(async () => {
  await resetDatabase();
  await seedTestData();
  await clearLocalStorage();
  await clearCookies();
});

// 各テスト後
afterEach(async () => {
  await cleanupTestData();
  await saveTestResults();
});
```

### 13.4 継続的実行

- **開発時**: 変更箇所の関連テストのみ実行
- **プルリクエスト**: Priority 1,2のテスト実行
- **デプロイ前**: 全テスト実行
- **定期実行**: 夜間に全テスト実行

## 14. 成功基準

### 14.1 カバレッジ目標
- **クリティカルパス**: 100%カバレッジ
- **主要機能**: 95%以上カバレッジ
- **エッジケース**: 80%以上カバレッジ

### 14.2 パフォーマンス基準
- **ページロード**: 3秒以内
- **API応答**: 1秒以内
- **インタラクション**: 100ms以内

### 14.3 信頼性基準
- **テスト成功率**: 98%以上
- **フレーキーテスト**: 2%以下
- **実行時間**: 30分以内