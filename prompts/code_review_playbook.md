# コードレビュー・プレイブック（テンプレ）
## 目的
- 短時間で"壊してない/筋が良い"を見抜き、建設的に合意形成する。
## タスク内容
- 差分の意図理解（チケット/仕様/設計との整合）
- 影響範囲とリスクの評価
- 具体的な指摘/問いかけ/受け入れ基準チェック
- 最終判断（Approve/Request Changes/Comment）
## 使うタイミング
- PRが作成された時いつでも
- セルフレビューの補助としても可
## 入力
- PR: {ブランチ/差分/本文/関連Issue}
- 実行結果: {Jest/Playwright/ビルド/静的解析}
- ドキュメント: {tasks/*.md, docs/specs/*.md}
## 手順（I-R-Q-D ループ：Intent→Risk→Questions→Decision）
1) **Intent（意図）**
   - PR本文の目的を1文で要約し、自分の理解を書き出す
   - 仕様/設計（`tasks/*.md`, `docs/specs/*.md`）と突き合わせ
2) **Risk（リスク/影響）**
   - 互換性: API/スキーマ/公開関数の破壊有無
   - 性能: N+1/全表掃引/インデックス/大量データ
   - 信頼性: 冪等/再送/時刻/並行性/リトライ/タイムアウト
   - セキュリティ: 権限境界/PII/暗号化/監査
   - 運用: ログ/メトリクス/アラート/フィーチャーフラグ
3) **Questions（質問/指摘）**
   - **観点別チェックリスト**
     - 設計: 責務分割は適切？凝集度/結合度は？
     - コード: 可読性/命名/副作用/例外/早期return/コメントの質
     - テスト: 正常/異常/境界/大量/冪等の網羅・再現性
     - Docs: `docs/specs` と実装が一致、`tasks` のDoD満たす？
   - **質問テンプレ**
     - 「この変更で既存クライアントが壊れない根拠は何ですか？」
     - 「再送/重複イベント時の挙動はどう設計していますか？」
     - 「N+1の可能性とインデックス計画を教えてください」
     - 「失敗時の補償/リトライ/タイムアウト設定は？」
     - 「相関IDやアラートはどこで観測できますか？」
4) **Decision（結論）**
   - **Approve**: 重大リスクなし。軽微な改善はコメントで。
   - **Request Changes**: 受入基準未達/仕様乖離/重大リスク。
   - **Comment**: 情報共有や任意改善。
   - PR本文に **要約** を追記: 目的/主要差分/実行結果/残課題。
## 出力
- レビューコメント（質問/改善提案/根拠リンク付き）
- 最終判断（Approve/Request Changes/Comment）
- 必要に応じて `tasks/*.md` や `docs/specs/*.md` への追記依頼
## 指摘コメントの書き方（雛形）
- **Context**: {ファイル/行/現象}
- **Why**: {リスク/規約/ユーザー影響}
- **Suggestion**: {具体案 or 参考コード or ドキュメント}
- **Scope**: {必須/任意/次回でも可}
> 例）
> Context: `src/app/services/catalog.ts:120` で `Promise.all` に非決定順の依存
> Why: 並行で順序保証が崩れ、表示がランダム化するリスク
> Suggestion: 並行は維持しつつ `map` に index を保持し、戻し順を固定
> Scope: 必須（UI破壊の可能性あり）
## 受入基準(DoR/DoD) 簡易チェック
- DoR（開始前準備）: 目的/範囲/非範囲/締切/テスト方針が明記
- DoD（完了の定義）: テスト緑/ドキュメント同期/監視更新/後方互換OK
## サンプル（ダミー）
- PR: 「検索APIに並び替え/ページング追加」
- 判定: Request Changes（ページング境界テストとインデックス説明が不足）